<html>
<head></head>

<body>
<!-- TAG START { player: "test player", owner: "Vidible", for: "Vidible" } -->                 <div id="5bab5f1bc0e0af6d67795cf5" class="vdb_player vdb_5bab5f1bc0e0af6d67795cf550d595ec0364e95588c77bd2" >                    <script type="text/javascript" src="//delivery.vidible.tv/jsonp/pid=5bab5f1bc0e0af6d67795cf5/50d595ec0364e95588c77bd2.js"></script>                </div>                <!-- TAG END { date: 09/26/18 } -->
 <p>1. Two weeks ago rmq prod was hit by a queue of ~2 million messages that were not consumed in time. Combined with that we have old and buggy versions of RMQ and underlying Erlang distribution installed, this caused overall cluster instabilities, and probably corrupted local state of rmq. Rolling restarts and queues purge did recover the cluster itself, but it became unstable since then. Fixing this completely requires complete cluster reset, which we can’t afford.
2. Overall cluster instability caused the existing issue of leaking rmq channels to escalate. Cluster was dropping connections, leading to clients creating more new channels, and more channels were leading to cluster being even more unstable, and dropping even more channels, etc.
3. RMQ latency caused core services to be very slow, which in turn led to video upload issue. Restarting rmq to close channels, and then restarting all core services to reconnect to rmq temporarily resolved this.
4. In addition to this, on monday when we were reconfiguring cluster to add more memory (so it can tolerate more channels) we were hit by issue https://github.com/rabbitmq/rabbitmq-server/issues/1519 that is not fixed in server version we have. This causes all queues to concentrate on one node in cluster leading to node crash and cluster unavailability. We’ve disabled this setting for now.

Leaking channels problem were identified and fixed in common library as @guyzuck mentioned. From infra side existing RMQ cluster was reconfigured and now it should tolerate more connections/channels. We are working on new cluster which will have latest rmq and erlang version. Plus there is a discussion about creating separate clusters by function</p>
 </body> 
</html>
